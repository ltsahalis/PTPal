<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - PT Pal</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Lustria:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="/">
                    <img src="/images/Screenshot_2025-11-16_at_6.08.36_PM-removebg-preview.png" alt="PT Pal Logo" class="logo-icon">
                    <span class="logo-text">PT Pal</span>
                </a>
            </div>
            <ul class="nav-menu" id="account-nav-menu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="#" class="nav-link nav-link-disabled" onclick="return false;">Exercises</a></li>
                <li><a href="#" class="nav-link nav-link-disabled" onclick="return false;">About</a></li>
                <li><a href="#" class="nav-link nav-link-disabled" onclick="return false;">Contact</a></li>
            </ul>
            <div class="nav-buttons">
                <button class="nav-login" onclick="window.location.href='/account.html'">My Account</button>
                <button class="nav-logout" onclick="handleLogout()">Log Out</button>
            </div>
        </div>
    </nav>

    <!-- Account Section -->
    <section class="account-section">
        <div class="container">
            <div class="account-header">
                <h1>Welcome back, <span id="user-name">User</span>! üëã</h1>
                <p>Track your progress and continue your physical therapy journey</p>
                <div class="overall-progress-container">
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar" id="overall-progress-bar">
                            <div class="progress-bar-fill" id="overall-progress-fill"></div>
                        </div>
                        <span class="progress-percentage" id="progress-percentage">0%</span>
                    </div>
                </div>
            </div>

            <!-- Progress Cards -->
            <div class="progress-grid">
                <div class="progress-card">
                    <div class="progress-icon"><img src="/images/Screenshot_2025-11-18_at_12.18.23_PM-removebg-preview.png" alt="Star Badge" style="width: 5rem; height: 5rem; object-fit: contain;"></div>
                    <h3>Total Stars</h3>
                    <div class="progress-value" id="total-stars">0</div>
                    <p>Keep exercising to earn more!</p>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">üèÜ</div>
                    <h3>Current Level</h3>
                    <div class="progress-value" id="current-level">Level 1</div>
                    <p>You're doing great!</p>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">üî•</div>
                    <h3>Day Streak</h3>
                    <div class="progress-value" id="day-streak">0 Days</div>
                    <p>Keep the streak going!</p>
                </div>
                <div class="progress-card">
                    <div class="progress-icon">‚úÖ</div>
                    <h3>Exercises Completed</h3>
                    <div class="progress-value" id="exercises-completed">0</div>
                    <p>Great job on your progress!</p>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="activity-section">
                <h2>Recent Activity</h2>
                <div class="activity-list" id="activity-list">
                    <div class="activity-item">
                        <div class="activity-content">
                            <h4>Welcome to PT Pal!</h4>
                            <p>You've joined the PT Pal community. Start your first session to begin tracking your progress!</p>
                            <span class="activity-date">Today</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Begin Session Button -->
            <div class="session-section">
                <button class="btn btn-primary btn-large btn-session" id="begin-session-btn">
                    Begin Session
                </button>
                <p class="session-note">Click to start a new physical therapy session</p>
            </div>
        </div>
    </section>

    <script>
        // Hide navigation menu on account page (logged-in page)
        document.addEventListener('DOMContentLoaded', () => {
            const navMenu = document.getElementById('account-nav-menu');
            if (navMenu) {
                navMenu.style.display = 'none';
            }
        });

        // Load user data
        const user = JSON.parse(localStorage.getItem('user') || '{}');
        
        if (user.name) {
            document.getElementById('user-name').textContent = user.name;
        } else {
            // If no user data, redirect to auth page
            window.location.href = '/auth.html';
        }

        // Check if this is the special demo user (case-insensitive email)
        const isDemoUser = user.email && user.email.toLowerCase() === 'janedoe@gmail.com' && user.password === 'helloworld';
        
        // Fetch and update progress stats from backend
        async function loadProgressStats() {
            try {
                const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? `https://${window.location.hostname}:8001`
                    : '';
                
                const response = await fetch(`${apiBaseUrl}/api/recent-activity`);
                const data = await response.json();
                
                let totalStars = 0;
                let exercisesCompleted = 0;
                let uniqueSessions = new Set();
                
                if (data.status === 'success' && data.activities) {
                    data.activities.forEach(activity => {
                        uniqueSessions.add(activity.session_id);
                        exercisesCompleted += activity.exercise_count || 0;
                        // Total stars = sum of average scores (rounded) for all exercises
                        totalStars += Math.round(activity.average_score * activity.exercise_count) || 0;
                    });
                }
                
                // Calculate level based on total stars (every 50 stars = 1 level, starting at level 1)
                const level = Math.max(1, Math.floor(totalStars / 50) + 1);
                
                // Calculate day streak (simplified - count unique days with sessions)
                // For now, use number of sessions as a proxy
                const dayStreak = uniqueSessions.size;
                
                // For demo user, add some bonus stats if real data is sparse
                let progress;
                if (isDemoUser && exercisesCompleted < 5) {
                    progress = {
                        totalStars: Math.max(totalStars, 12),
                        level: Math.max(level, 7),
                        dayStreak: Math.max(dayStreak, 7),
                        exercisesCompleted: Math.max(exercisesCompleted, 30)
                    };
                } else {
                    progress = {
                        totalStars: totalStars,
                        level: level,
                        dayStreak: dayStreak,
                        exercisesCompleted: exercisesCompleted
                    };
                }
                
                // Display the progress
                document.getElementById('total-stars').textContent = progress.totalStars;
                document.getElementById('current-level').textContent = 'Level ' + progress.level;
                document.getElementById('day-streak').textContent = progress.dayStreak + ' Day' + (progress.dayStreak !== 1 ? 's' : '');
                document.getElementById('exercises-completed').textContent = progress.exercisesCompleted;
                
                // Update progress bar (based on level progress)
                const levelProgress = (totalStars % 50) / 50 * 100;
                document.getElementById('overall-progress-fill').style.width = levelProgress + '%';
                document.getElementById('progress-percentage').textContent = Math.round(levelProgress) + '%';
                
            } catch (error) {
                console.error('Error loading progress stats:', error);
                // Fallback to default or demo stats
                let progress;
                if (isDemoUser) {
                    progress = {
                        totalStars: 12,
                        level: 7,
                        dayStreak: 7,
                        exercisesCompleted: 30
                    };
                } else {
                    progress = {
                        totalStars: 0,
                        level: 1,
                        dayStreak: 0,
                        exercisesCompleted: 0
                    };
                }
                
                document.getElementById('total-stars').textContent = progress.totalStars;
                document.getElementById('current-level').textContent = 'Level ' + progress.level;
                document.getElementById('day-streak').textContent = progress.dayStreak + ' Day' + (progress.dayStreak !== 1 ? 's' : '');
                document.getElementById('exercises-completed').textContent = progress.exercisesCompleted;
                document.getElementById('overall-progress-fill').style.width = (isDemoUser ? 50 : 0) + '%';
                document.getElementById('progress-percentage').textContent = (isDemoUser ? 50 : 0) + '%';
            }
        }
        
        // Load progress stats on page load
        loadProgressStats();

        // Set overall progress bar
        const overallProgress = isDemoUser ? 50 : 0;
        document.getElementById('overall-progress-fill').style.width = overallProgress + '%';
        document.getElementById('progress-percentage').textContent = overallProgress + '%';

        // Fetch and display recent activity from backend
        async function loadRecentActivity() {
            const activityList = document.getElementById('activity-list');
            
            try {
                // Determine API base URL
                const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? `https://${window.location.hostname}:8001`
                    : '';
                
                const response = await fetch(`${apiBaseUrl}/api/recent-activity`);
                const data = await response.json();
                
                if (data.status === 'success' && data.activities && data.activities.length > 0) {
                    activityList.innerHTML = ''; // Clear the welcome message
                    
                    // For demo user, also show demo data if available
                    if (isDemoUser && data.activities.length < 3) {
                        // Add some demo activities if real data is sparse
                        const demoActivities = [
                            {
                                session_id: 'demo_session_7',
                                sessionNumber: 7,
                                exercises: ['Partial Squat', 'Tree Pose', 'Heel Raises', 'Single Leg Stance', 'Tandem Stance'],
                                totalScore: 450,
                                date: '2 days ago',
                                exercise_count: 5
                            },
                            {
                                session_id: 'demo_session_6',
                                sessionNumber: 6,
                                exercises: ['Functional Reach', 'Partial Squat', 'Tree Pose', 'Heel Raises', 'Single Leg Stance'],
                                totalScore: 442,
                                date: '3 days ago',
                                exercise_count: 5
                            }
                        ];
                        
                        // Combine real and demo data
                        const allActivities = [...data.activities, ...demoActivities.slice(0, 7 - data.activities.length)];
                        displayActivities(allActivities, activityList);
                    } else {
                        displayActivities(data.activities, activityList);
                    }
                } else {
                    // No real data - show welcome message or demo data for demo user
                    if (isDemoUser) {
                        activityList.innerHTML = '';
                        const demoActivities = [
                            {
                                sessionNumber: 7,
                                exercises: ['Partial Squat', 'Tree Pose', 'Heel Raises', 'Single Leg Stance', 'Tandem Stance'],
                                totalScore: 450,
                                date: '2 days ago'
                            },
                            {
                                sessionNumber: 6,
                                exercises: ['Functional Reach', 'Partial Squat', 'Tree Pose', 'Heel Raises', 'Single Leg Stance'],
                                totalScore: 442,
                                date: '3 days ago'
                            },
                            {
                                sessionNumber: 5,
                                exercises: ['Tandem Stance', 'Functional Reach', 'Partial Squat', 'Tree Pose', 'Heel Raises'],
                                totalScore: 435,
                                date: '4 days ago'
                            }
                        ];
                        displayActivities(demoActivities, activityList);
                    }
                    // For other users, keep the welcome message
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
                // On error, show demo data for demo user, otherwise keep welcome message
                if (isDemoUser) {
                    activityList.innerHTML = '';
                    const demoActivities = [
                        {
                            session_id: 'demo_session_1',
                            sessionNumber: 1,
                            exercises: ['Partial Squat', 'Tree Pose', 'Heel Raises'],
                            totalScore: 410,
                            date: 'Recently',
                            exercise_count: 3
                        }
                    ];
                    displayActivities(demoActivities, activityList);
                }
            }
        }
        
        function displayActivities(activities, activityList) {
            activities.forEach((activity, index) => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                const exercisesList = activity.exercises.join(', ');
                const sessionNumber = activity.sessionNumber || (activities.length - index);
                const totalScore = activity.totalScore || (activity.average_score * activity.exercise_count) || 0;
                const maxScore = (activity.exercise_count || activity.exercises.length) * 5; // Max 5 stars per exercise
                const sessionId = activity.session_id || `session_${sessionNumber}`;
                const exerciseCount = activity.exercise_count || activity.exercises.length;
                
                activityItem.innerHTML = `
                    <div class="activity-content">
                        <div class="activity-header">
                            <div class="activity-info">
                                <h4>Session ${sessionNumber}:</h4>
                                <p>Completed ${exerciseCount} ${exerciseCount === 1 ? 'exercise' : 'exercises'}: ${exercisesList}. Total Score: ${Math.round(totalScore)}/${maxScore}</p>
                                <span class="activity-date">${activity.date || 'Recently'}</span>
                            </div>
                            <div class="activity-actions">
                                <button class="btn-view-summary" data-session-id="${sessionId}" onclick="viewParentSummary('${sessionId}', ${sessionNumber})">
                                    View Parent Summary
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                activityList.appendChild(activityItem);
            });
        }
        
        // Function to view parent summary
        async function viewParentSummary(sessionId, sessionNumber) {
            // Create or get modal
            let modal = document.getElementById('parent-summary-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'parent-summary-modal';
                modal.className = 'parent-summary-modal';
                document.body.appendChild(modal);
            }
            
            // Update modal content with current session number
            modal.innerHTML = `
                <div class="parent-summary-modal-content">
                    <div class="parent-summary-modal-header">
                        <h2>Parent Summary - Session ${sessionNumber}</h2>
                        <button class="parent-summary-close" onclick="closeParentSummary()">&times;</button>
                    </div>
                    <div class="parent-summary-modal-body" id="parent-summary-modal-body">
                        <div class="parent-summary-loading" id="parent-summary-loading">
                            <p>Loading parent summary...</p>
                        </div>
                        <div class="parent-summary-content hidden" id="parent-summary-content"></div>
                    </div>
                </div>
            `;
            
            // Show modal
            modal.style.display = 'flex';
            document.getElementById('parent-summary-loading').style.display = 'block';
            document.getElementById('parent-summary-content').classList.add('hidden');
            
            try {
                const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? `https://${window.location.hostname}:8001`
                    : '';
                
                const response = await fetch(`${apiBaseUrl}/api/parent-summary/${sessionId}`);
                const data = await response.json();
                
                if (data.status === 'success' && data.parent_summary) {
                    const summary = data.parent_summary;
                    const contentDiv = document.getElementById('parent-summary-content');
                    
                    let html = '';
                    
                    // Overall Assessment
                    if (summary.overall_assessment) {
                        html += `
                            <div class="parent-summary-section">
                                <h3 class="parent-summary-title">Overall Assessment</h3>
                                <p class="parent-summary-text">${summary.overall_assessment}</p>
                            </div>
                        `;
                    }
                    
                    // Strengths
                    if (summary.strengths && summary.strengths.length > 0) {
                        html += `
                            <div class="parent-summary-section">
                                <h3 class="parent-summary-title">Strengths</h3>
                                <ul class="parent-summary-list">
                                    ${summary.strengths.map(strength => `<li>${strength}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Areas for Improvement
                    if (summary.improvements_needed && summary.improvements_needed.length > 0) {
                        html += `
                            <div class="parent-summary-section">
                                <h3 class="parent-summary-title">Areas for Improvement</h3>
                                <ul class="parent-summary-list">
                                    ${summary.improvements_needed.map(improvement => `<li>${improvement}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    // Technical Notes
                    if (summary.technical_notes) {
                        html += `
                            <div class="parent-summary-section">
                                <h3 class="parent-summary-title">Technical Notes</h3>
                                <p class="parent-summary-text">${summary.technical_notes}</p>
                            </div>
                        `;
                    }
                    
                    // Recommendations
                    if (summary.recommendations && summary.recommendations.length > 0) {
                        html += `
                            <div class="parent-summary-section">
                                <h3 class="parent-summary-title">Recommendations</h3>
                                <ul class="parent-summary-list">
                                    ${summary.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    
                    contentDiv.innerHTML = html;
                    document.getElementById('parent-summary-loading').style.display = 'none';
                    contentDiv.classList.remove('hidden');
                } else {
                    throw new Error(data.message || 'Failed to load parent summary');
                }
            } catch (error) {
                console.error('Error loading parent summary:', error);
                document.getElementById('parent-summary-loading').innerHTML = `
                    <p style="color: #E53E3E;">Error loading summary: ${error.message}</p>
                `;
            }
        }
        
        // Function to close parent summary modal
        function closeParentSummary() {
            const modal = document.getElementById('parent-summary-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('parent-summary-modal');
            if (modal && event.target === modal) {
                closeParentSummary();
            }
        });
        
        // Load recent activity on page load
        loadRecentActivity();

        // Reload activity when page becomes visible (user returns from session)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                loadRecentActivity();
                loadProgressStats();
            }
        });

        // Also reload when window gets focus (alternative trigger)
        window.addEventListener('focus', () => {
            loadRecentActivity();
            loadProgressStats();
        });

        // Begin Session button - navigate to session page
        document.getElementById('begin-session-btn').addEventListener('click', () => {
            window.location.href = '/session';
        });

        // Logout function
        function handleLogout() {
            // Clear user data from localStorage
            localStorage.removeItem('user');
            localStorage.removeItem('progress');
            
            // Redirect to homepage
            window.location.href = '/';
        }
    </script>
</body>
</html>

